<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì¡°íšŒ ê²°ê³¼</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="container mt-5">
    <h1>ğŸ“‹ ì¡°íšŒ ê²°ê³¼</h1>

    <!-- âœ… ìš”ì•½ ì •ë³´ -->
    {% if data and 'summary' in data and data['summary'] %}
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <h5 class="card-title">í˜„ì¥ì½”ë“œ</h5>
                    <p class="h4">{{ data['summary'][0]['SiteCode'] }}</p>
                </div>
                <div class="col-md-3">
                    <h5 class="card-title">í˜„ì¥ëª…</h5>
                    <p class="h4">{{ data['summary'][0]['SiteName'] }}</p>
                </div>
                <div class="col-md-3">
                    <h5 class="card-title">ê³„ì•½ë¬¼ëŸ‰</h5>
                    <p class="h4">{{ "{:,.0f}".format(data['summary'][0]['Quantity']) }} ã¡</p>
                </div>
                <div class="col-md-3">
                    <h5 class="card-title">ê³„ì•½ê¸ˆì•¡</h5>
                    <p class="h4">{{ "{:,.0f}".format(data['summary'][0]['ContractAmount']) }} ì›</p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- KPI ì¹´ë“œ ì„¹ì…˜ -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h5 class="card-title">ğŸ“¦ ë¬¼ëŸ‰ ì§„í–‰ë¥ </h5>
                    <h2 class="card-text text-success">{{ "{:.1f}%".format(data.get("quantity_progress", 0)) }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card bg-light">
                <div class="card-body text-center">
                    <h5 class="card-title">ğŸ’µ ì´ ë¹„ìš©</h5>
                    <h2 class="card-text text-danger">{{ "{:,.0f}".format(data.get("total_cost", 0)) }}ì›</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">ì›”ë³„ ì¶œê³ ëŸ‰ ì¶”ì´</h5>
                    <canvas id="shipmentChart"></canvas>
                </div>
            </div>
            <!-- ì£¼ìš” TGíƒ€ì… ì›”ë³„ ë‹¨ê°€ ì°¨íŠ¸ -->
            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">ì£¼ìš” TGíƒ€ì… ì›”ë³„ ë‹¨ê°€ ì¶”ì´</h5>
                    <canvas id="priceChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">TGíƒ€ì…ë³„ ë¶„í¬</h5>
                    <canvas id="tgTypeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <a href="{{ url_for('download_excel') }}" class="btn btn-success">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</a>
    </div>

    <!-- âœ… 1. ìì¬ë¹„ -->
    <h2>ğŸ—ï¸ 1. ìì¬ë¹„</h2>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>TGíƒ€ì…</th>
                <th>ìˆ˜ëŸ‰ (ã¡)</th>
                <th>ë‹¨ê°€ (ì›/ã¡)</th>
                <th>ê¸ˆì•¡ (ì›)</th>
                <th>ì¶œê³ ì‹œì‘ì›”</th>
                <th>ì¶œê³ ì¢…ë£Œì›”</th>
            </tr>
        </thead>
        <tbody>
            {% for row in data.get("material", []) %}
            <tr>
                <td>{{ row.get("TGType", "-") }}</td>
                <td>{{ "{:,.0f}".format(row.get("TotalQuantity", 0)) }}</td>
                <td>{{ "{:,.0f}".format(row.get("AvgPrice", 0)) }}</td>
                <td>{{ "{:,.0f}".format(row.get("TotalAmount", 0)) }}</td>
                <td>{{ row.get("StartMonth", "-") }}</td>
                <td>{{ row.get("EndMonth", "-") }}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td><strong>ì†Œê³„</strong></td>
                <td>{{ "{:,.0f}".format(data.get("material_total", {}).get("total_quantity", 0)) }}</td>
                <td>-</td>
                <td>{{ "{:,.0f}".format(data.get("material_total", {}).get("total_amount", 0)) }}</td>
                <td>{{ data.get("material_total", {}).get("start_month", "-") }}</td>
                <td>{{ data.get("material_total", {}).get("end_month", "-") }}</td>
            </tr>
        </tfoot>
    </table>
    
    <!-- âœ… 2. ë¶€ìì¬ë¹„ -->
    <h2>ğŸ”© 2. ë¶€ìì¬ë¹„</h2>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>íƒ€ì…</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>ê¸ˆì•¡ (ì›)</th>
                <th>ë‹¨ê°€ (ì›)</th>
                <th>êµ¬ë§¤ì‹œì‘ì›”</th>
                <th>êµ¬ë§¤ì¢…ë£Œì›”</th>
            </tr>
        </thead>
        <tbody>
            {% for row in data.get("submaterial", []) %}
            <tr>
                <td>{{ row.get("SubmaterialType", "-") }}</td>
                <td>{{ "{:,.0f}".format(row.get("TotalAmount", 0)) }}</td>
                <td>{{ "{:,.0f}".format(row.get("TotalQuantity", 0)) }}</td>
                <td>{{ "{:,.0f}".format(row.get("AvgPrice", 0)) }}</td>
                <td>{{ row.get("StartMonth", "-") }}</td>
                <td>{{ row.get("EndMonth", "-") }}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td><strong>ì†Œê³„</strong></td>
                <td>{{ "{:,.0f}".format(data.get("submaterial_total", {}).get("total_quantity", 0)) }}</td>
                <td>{{ "{:,.0f}".format(data.get("submaterial_total", {}).get("total_amount", 0)) }}</td>  <!-- ìœ„ì¹˜ ë³€ê²½ -->
                <td>-</td>
                <td>{{ data.get("submaterial_total", {}).get("start_month", "-") }}</td>
                <td>{{ data.get("submaterial_total", {}).get("end_month", "-") }}</td>
            </tr>
        </tfoot>
    </table>

    <!-- âœ… 3. í˜„ì¥ ìƒì„¸ì¡°íšŒ -->
    <h2>ğŸ“Œ 3. í˜„ì¥ ìƒì„¸ì¡°íšŒ</h2>
    {% if data.get("details") %}
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>í˜„ì¥ì½”ë“œ</th>
                <th>TGType</th>
                <th>ì—°ë„</th>
                <th>ì¶œê³ ìˆ˜ëŸ‰ (ã¡)</th>
                <th>ê¸ˆì•¡ (ì›)</th>
                <th>ë‹¨ê°€ (ì›/ã¡)</th>
            </tr>
        </thead>
        <tbody>
            {% for row in data.get("details", []) %}
            <tr>
                <td>{{ row.get("SiteCode", "-") }}</td>
                <td>{{ row.get("TGType", "-") }}</td>
                <td>{{ row.get("Month", "-") }}</td>
                <td>{{ "{:,.2f}".format(row.get("ShipmentQuantity", 0)) }}</td>
                <td>{{ "{:,.0f}".format(row.get("Amount", 0)) }}</td>
                <td>{{ "{:,.0f}".format(row.get("Price", 0)) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>ğŸ“Œ í˜„ì¥ ìƒì„¸ì¡°íšŒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
</body>
<script>
function initializeCharts() {
    // ì›”ë³„ ì¶œê³ ëŸ‰ ì°¨íŠ¸
    const shipmentCtx = document.getElementById('shipmentChart').getContext('2d');
    const monthlyData = {
        labels: {{ data.get('months', []) | tojson | safe }},
        datasets: [{
            label: 'ì›”ë³„ ì¶œê³ ëŸ‰',
            data: {{ data.get('monthly_shipments', []) | tojson | safe }},
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 1
        }]
    };
    
    new Chart(shipmentCtx, {
        type: 'bar',
        data: monthlyData,
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // TGíƒ€ì…ë³„ ë¶„í¬ ì°¨íŠ¸
    const tgTypeCtx = document.getElementById('tgTypeChart').getContext('2d');
    const tgTypeData = {
        labels: {{ data.get('tg_types', []) | tojson | safe }},
        datasets: [{
            data: {{ data.get('tg_type_quantities', []) | tojson | safe }},
            backgroundColor: [
                'rgba(255, 99, 132, 0.2)',
                'rgba(54, 162, 235, 0.2)',
                'rgba(255, 206, 86, 0.2)',
                'rgba(75, 192, 192, 0.2)'
            ],
            borderWidth: 1
        }]
    };

    new Chart(tgTypeCtx, {
        type: 'pie',
        data: tgTypeData,
        options: {
            responsive: true
        }
    });

    // ì£¼ìš” TGíƒ€ì… ì›”ë³„ ë‹¨ê°€ ì°¨íŠ¸
    const priceCtx = document.getElementById('priceChart').getContext('2d');
    const priceData = {
        labels: {{ data.get('months', []) | tojson | safe }},
        datasets: [{
            label: {{ data.get('main_tg_price_dataset', {}).get('label', '') | tojson | safe }},
            data: {{ data.get('main_tg_price_dataset', {}).get('data', []) | tojson | safe }},
            borderColor: {{ data.get('main_tg_price_dataset', {}).get('borderColor', 'rgb(54, 162, 235)') | tojson | safe }},
            fill: false,
            tension: 0.4
        }]
    };

    new Chart(priceCtx, {
        type: 'line',
        data: priceData,
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'ë‹¨ê°€ (ì›/ã¡)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', initializeCharts);
</script>
</html>
